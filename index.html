<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mapa Foresight CAIXA — Painel Fixo</title>
<style>
:root{
  --bg:#fff; --ink:#1f1f2e; --muted:#6f6a7c;
  --axis:#c7b6df; --grid:#ebe6f5; --panel:#fdf7fd;
  --pill-shadow: rgba(33,12,51,.10);
  --c1:#6e56a3;  --c2:#9d8ec4;  --c3:#c7b6df;  --c4:#f2b6cd;
  --c5:#8bd1c2;  --c6:#a3b3c8;  --c7:#d5c7eb;  --c8:#f7c9dc;
}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;background:var(--bg);color:var(--ink)}
header{text-align:center;margin-bottom:8px}
h1{margin:0;color:var(--c1);font-size:20px}
.sub{color:var(--muted);font-size:12px;margin-top:4px}
.layout{display:grid;grid-template-columns: 220px 1fr 420px;gap:12px;max-width:1400px;margin:0 auto;align-items:start}

.left{position:relative; height:600px}
.pillarLabel{position:absolute; left:0; transform:translateY(-50%); color:var(--muted); font-size:13px; white-space:nowrap}

.canvasWrap{position:relative}
canvas{border:1px solid var(--grid);border-radius:16px;width:100%;height:600px;background:#fff;box-shadow:0 8px 28px var(--pill-shadow)}
.xlabels{position:absolute;left:0;right:0;bottom:10px;display:flex;justify-content:space-between;color:var(--muted);font-size:13px;pointer-events:none;padding:0 18px}

.tools{display:flex;gap:8px;margin:10px 0 0 0}
.btn{border:1px solid var(--axis);background:#fff;border-radius:10px;padding:6px 10px;font-size:12px;color:#3b3355;cursor:pointer}
.btn:active{transform:translateY(1px)}

/* Painel fixo à direita */
.detail{position:sticky; top:0; background:var(--panel); border:1px solid var(--grid);
  border-radius:16px; box-shadow:0 12px 36px var(--pill-shadow); padding:16px; min-height:600px}
.detail h3{margin:0 0 8px 0;color:var(--c1);font-size:18px}
.detail h4{margin:10px 0 4px 0;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.03em}
.detail p{margin:0 0 6px 0;font-size:13px;line-height:1.35}
.tag{display:inline-block;background:#f6f1fb;border:1px solid var(--axis);padding:2px 8px;border-radius:999px;font-size:11px;margin:2px 4px 0 0}
.helper{color:var(--muted);font-size:12px;margin:0 0 6px 0}
.activeStroke{outline:2px solid #ffffff88; box-shadow:0 0 0 3px #00000010 inset}
.footer-note{grid-column: 1 / -1; margin-top:10px; color:var(--muted); font-size:11px; text-align:center}
</style>
</head>
<body>
<header>
  <h1>Mapa Foresight CAIXA — Tendências × Pilares (Painel Fixo)</h1>
  <div class="sub">Clique em uma pílula para atualizar o painel. Arraste para reposicionar. Copie as posições (JSON) para salvar no <code>data.json</code>.</div>
</header>

<div class="layout">
  <!-- Coluna dos pilares -->
  <div class="left" id="pillarCol"></div>

  <!-- Canvas -->
  <div class="canvasWrap">
    <canvas id="map"></canvas>
    <div class="xlabels"><div>Gênese</div><div>Custom</div><div>Produto</div><div>Commodity</div></div>
    <div class="tools">
      <button class="btn" id="copyBtn">Copiar posições (JSON)</button>
      <button class="btn" id="resetBtn">Recarregar dados</button>
    </div>
  </div>

  <!-- Painel fixo -->
  <aside id="detail" class="detail" role="region" aria-labelledby="dTitle">
    <p class="helper" id="helper">Selecione uma tendência no mapa para ver detalhes aqui.</p>
    <h3 id="dTitle">—</h3>
    <h4>Impacto no Cliente</h4><p id="dImpact">—</p>
    <h4>Riscos</h4><p id="dRisks">—</p>
    <h4>Oportunidades</h4><p id="dOpps">—</p>
    <h4>Status</h4><p id="dStatus">—</p>
    <h4>Alavancas de inovação</h4><div id="dLevers"></div>
  </aside>

  <div class="footer-note">Fonte: Célula de Futuros e Inovação — GEINA | Mapa interativo (GitHub Pages)</div>
</div>

<script>
// ===== Configurações =====
const PILARES = [
  "Cliente no centro",
  "Eficiência e rentabilidade",
  "Atuar no ecossistema",
  "Tecnologia, inovação",
  "Sustentabilidade",
  "Pessoas, cultura e agilidade"
];
const COLORS = getPalette();
const LEFT_PAD=18, RIGHT_PAD=18, TOP_PAD=18, BOTTOM_PAD=64; // canvas ocupa toda a coluna
const PILL_H=30, PILL_RX=16, TEXT_PADX=12;
const canvas=document.getElementById('map'), ctx=canvas.getContext('2d');
let nodes=[], boxes=[], dragging=null, dragOffset={x:0,y:0};
let mdown=null; // para distinguir clique x arraste
let activeIndex = -1;

function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
function getPalette(){ return ['--c1','--c2','--c3','--c4','--c5','--c6','--c7','--c8'].map(getVar); }
function roundedRect(x,y,w,h,r){
  const p=new Path2D(); const rr=Math.min(r,h/2,w/2);
  p.moveTo(x+rr,y); p.lineTo(x+w-rr,y); p.quadraticCurveTo(x+w,y,x+w,y+rr);
  p.lineTo(x+w,y+h-rr); p.quadraticCurveTo(x+w,y+h,x+w-rr,y+h);
  p.lineTo(x+rr,y+h); p.quadraticCurveTo(x,y+h,x,y+h-rr);
  p.lineTo(x,y+rr); p.quadraticCurveTo(x,y,x+rr,y); return p;
}

function placePillars(){
  const col = document.getElementById('pillarCol');
  col.innerHTML = '';
  const h = col.getBoundingClientRect().height;
  const top = TOP_PAD, bottom = h - BOTTOM_PAD;
  const gap = (bottom - top) / (PILARES.length - 1);
  PILARES.forEach((name, i)=>{
    const y = top + i*gap;
    const s = document.createElement('div');
    s.className='pillarLabel';
    s.style.top = y + 'px';
    s.textContent = name;
    col.appendChild(s);
  });
}

function resize(){
  const r=canvas.getBoundingClientRect();
  canvas.width=r.width*devicePixelRatio;
  canvas.height=r.height*devicePixelRatio;
  ctx.setTransform(1,0,0,1,0,0); ctx.scale(devicePixelRatio,devicePixelRatio);
  placePillars();
  draw();
}

function drawGrid(left,right,top,bottom){
  // grid secundário interno
  ctx.strokeStyle=getVar('--grid'); ctx.lineWidth=1;
  const rows = (PILARES.length - 1) * 2;
  const cols = 12;
  for(let r=1;r<rows;r++){
    const y = top + r*(bottom-top)/rows;
    ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(right,y); ctx.stroke();
  }
  for(let c=1;c<cols;c++){
    const x = left + c*(right-left)/cols;
    ctx.beginPath(); ctx.moveTo(x,top); ctx.lineTo(x,bottom); ctx.stroke();
  }
  // linhas principais (eixos/guia)
  ctx.strokeStyle=getVar('--axis');
  ctx.beginPath(); ctx.moveTo(left,top); ctx.lineTo(left,bottom); ctx.lineTo(right,bottom); ctx.stroke();
  const gap=(bottom-top)/(PILARES.length-1);
  for(let i=0;i<PILARES.length;i++){ const y=top+i*gap; ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(right,y); ctx.stroke(); }
  for(let i=1;i<=3;i++){ const x=left+i*(right-left)/3; ctx.beginPath(); ctx.moveTo(x,top); ctx.lineTo(x,bottom); ctx.stroke(); }
}

function layoutPills(){
  const r=canvas.getBoundingClientRect();
  const left=LEFT_PAD, right=r.width-RIGHT_PAD, top=TOP_PAD, bottom=r.height-BOTTOM_PAD;
  const w=right-left, h=bottom-top;
  ctx.font='13px Inter, system-ui, sans-serif';
  let pills = nodes.map((n,i)=>{
    const cx = left + Math.min(Math.max(n.x,0),1)*w;
    const cy = bottom - Math.min(Math.max(n.y,0),1)*h;
    const tw = ctx.measureText(n.label).width;
    const pw = tw + TEXT_PADX*2 + 6;
    return {i, cx, cy, w: pw, h: PILL_H};
  });
  // Dodge vertical leve
  pills.sort((a,b)=> a.cy - b.cy);
  const MIN_GAP = 34;
  for(let i=1;i<pills.length;i++){
    const prev=pills[i-1], cur=pills[i];
    const nearX = Math.abs(cur.cx - prev.cx) < 120;
    const overlap = (prev.cy + MIN_GAP) - cur.cy;
    if(nearX && overlap>0){ cur.cy += overlap; }
  }
  return {pills,left,right,top,bottom};
}

function plot(){
  const r=canvas.getBoundingClientRect();
  const left=LEFT_PAD, right=r.width-RIGHT_PAD, top=TOP_PAD, bottom=r.height-BOTTOM_PAD;
  drawGrid(left,right,top,bottom);
  const {pills} = layoutPills();
  boxes=[];
  pills.forEach((p)=>{
    const n = nodes[p.i];
    const bx = Math.min(Math.max(p.cx - p.w/2, left+4), right - p.w - 4);
    const by = Math.min(Math.max(p.cy - p.h/2, top+4), bottom - p.h - 4);
    const color = COLORS[p.i % COLORS.length];
    const path = roundedRect(bx, by, p.w, p.h, PILL_H/2 + 1);
    ctx.shadowColor='rgba(33,12,51,.12)'; ctx.shadowBlur=8;
    ctx.fillStyle = color; ctx.fill(path);
    ctx.shadowBlur=0; ctx.lineWidth=1; ctx.strokeStyle='#ffffff22'; ctx.stroke(path);
    ctx.fillStyle = '#fff'; ctx.fillText(n.label, bx + TEXT_PADX, by + 19);
    boxes.push({x:bx,y:by,w:p.w,h:PILL_H,index:p.i});
    if (activeIndex === p.i){
      ctx.lineWidth = 2; ctx.strokeStyle = '#00000025'; ctx.stroke(path);
    }
  });
}

function draw(){ ctx.clearRect(0,0,canvas.getBoundingClientRect().width,canvas.getBoundingClientRect().height); plot(); }

function hit(mx,my){
  for(let i=boxes.length-1;i>=0;i--){
    const b=boxes[i];
    if(mx>=b.x && mx<=b.x+b.w && my>=b.y && my<=b.y+b.h) return b;
  }
  return null;
}

// ===== Interação com limiar de clique/arraste =====
canvas.addEventListener('mousedown', ev=>{
  const rect=canvas.getBoundingClientRect();
  const mx=ev.clientX-rect.left, my=ev.clientY-rect.top;
  const b = hit(mx,my);
  mdown = {x:mx,y:my,t:performance.now(), box:b};
  if(b){
    dragging = b;
    dragOffset.x = mx - b.x;
    dragOffset.y = my - b.y;
  }
});
window.addEventListener('mousemove', ev=>{
  if(!dragging) return;
  const rect=canvas.getBoundingClientRect();
  let mx=ev.clientX-rect.left, my=ev.clientY-rect.top;
  const left=LEFT_PAD, right=rect.width-RIGHT_PAD, top=TOP_PAD, bottom=rect.height-BOTTOM_PAD;
  const w=right-left, h=bottom-top;
  let nx = Math.min(Math.max(mx - dragOffset.x + dragging.w/2, left), right);
  let ny = Math.min(Math.max(my - dragOffset.y + dragging.h/2, top), bottom);
  const node = nodes[dragging.index];
  node.x = (nx - left)/w;
  node.y = (bottom - ny)/h;
  draw();
});
window.addEventListener('mouseup', ev=>{
  const rect=canvas.getBoundingClientRect();
  const mx=ev.clientX-rect.left, my=ev.clientY-rect.top;
  const CLICK_DIST = 5, CLICK_TIME = 350;
  dragging = null;
  if(mdown){
    const dist = Math.hypot(mx - mdown.x, my - mdown.y);
    const dt = performance.now() - mdown.t;
    if(dist <= CLICK_DIST && dt <= CLICK_TIME){
      const b = hit(mx,my) || mdown.box;
      if(b){ setActive(b.index); }
    }
  }
  mdown = null;
});

function setActive(i){
  activeIndex = i;
  const n = nodes[i];
  document.getElementById('helper').style.display = 'none';
  document.getElementById('dTitle').textContent = n.label || 'Tendência';
  document.getElementById('dImpact').textContent = n.impact || '—';
  document.getElementById('dRisks').textContent = n.risks || '—';
  document.getElementById('dOpps').textContent = n.opportunities || '—';
  document.getElementById('dStatus').textContent = n.status || '—';
  const dl = document.getElementById('dLevers'); dl.innerHTML="";
  let levers = n.levers || n.lever || [];
  if(typeof levers==='string') levers=[levers];
  levers.forEach(l=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=l; dl.appendChild(s); });
  draw();
}

// ===== Boot =====
async function boot(){
  try{
    const res = await fetch('data.json',{cache:'no-store'});
    const data = await res.json();
    nodes = Array.isArray(data.nodes) ? data.nodes : [];
  }catch(e){ nodes = []; }
  resize();
  if(nodes.length){ setActive(0); } // seleciona a primeira por padrão
}
document.getElementById('copyBtn').addEventListener('click', ()=>{
  const payload = {nodes: nodes.map(n=>({
    label:n.label, x:+n.x.toFixed(3), y:+n.y.toFixed(3),
    impact:n.impact, risks:n.risks, opportunities:n.opportunities, status:n.status, levers:n.levers
  }))};
  navigator.clipboard.writeText(JSON.stringify(payload,null,2));
  alert('Posições copiadas para a área de transferência!');
});
document.getElementById('resetBtn').addEventListener('click', ()=> boot());
window.addEventListener('resize', resize);
boot();
</script>
</body>
</html>
